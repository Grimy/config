#!/bin/sh

set -euo pipefail
set -- -xc -std=c99 -Wall -Wextra -Wno-unused -g

cd /tmp
printf 'int main(void){\n return 0;}\n' >tmp.c

until C=$(rlwrap -S 'C> ' sed q1); do
	if sed "\$i$C;" tmp.c | clang "$@" -; then
		printf "br %d\nr\np %s" "$(wc -l <tmp.c)" "$C" |\
			gdb -q ./a.out 2>&1 | sed -n 's/.*$1 = //;T;p'
		sed -i "\$i$C;" tmp.c
	fi
done
